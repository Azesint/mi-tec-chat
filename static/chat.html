<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TecChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            background-color: #fff; color: #000;
            position: fixed; width: 100%; height: 100dvh; overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }
        .app-container { display: flex; width: 100%; height: 100%; background: #fff; transition: background-color 0.3s; }
        
        /* --- SIDEBAR --- */
        .sidebar { 
            width: 350px; min-width: 300px; border-right: 1px solid #eee; 
            display: flex; flex-direction: column; background-color: #fff; z-index: 20; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .sidebar-header { 
            padding: 15px; background: #fff; border-bottom: 3px solid #ffd700; 
            display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .my-profile-info { display: flex; flex-direction: column; margin-left: 10px; }
        .my-name { font-weight: bold; font-size: 14px; }
        .my-about { font-size: 11px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .search-box { padding: 10px; border-bottom: 1px solid #eee; flex-shrink: 0; display: flex; gap: 5px; transition: border-color 0.3s; }
        .search-input { width: 100%; padding: 8px; border-radius: 20px; border: 2px solid #eee; outline: none; transition: background 0.3s, border 0.3s, color 0.3s; }
        .search-input:focus { border-color: #ffd700; } 
        
        .contact-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; -webkit-overflow-scrolling: touch; }
        
        .contact { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; height: 75px; transition: background-color 0.3s, border-color 0.3s; }
        .contact:hover { background-color: #f5f5f5; } 
        .contact.active-chat { background-color: #ffe082; } 
        
        .user-avatar { width: 50px; height: 50px; background: #eee; border-radius: 50%; margin-right: 15px; overflow: visible; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; flex-shrink: 0; position: relative; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .user-avatar i { font-size: 24px; color: #555; }
        .active-avatar { border-color: #ffd700; }

        .contact-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .contact-row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .name-wrapper { font-weight: 600; font-size: 16px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .contact-row-bottom { display: flex; align-items: center; font-size: 13px; color: #666; height: 18px; overflow: hidden; }
        .status-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        .status-dot { height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; margin-left: 8px; flex-shrink: 0; transition: background-color 0.3s; position: absolute; bottom: 0; right: 0; border: 2px solid #fff; }
        .is-online { background-color: #25d366; box-shadow: 0 0 4px #25d366; }
        .unread-badge { background-color: #ff3b30; color: white; font-size: 11px; font-weight: bold; padding: 2px 7px; border-radius: 12px; display: none; margin-left: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .change-avatar-btn { position: absolute; bottom: -2px; right: -2px; background: #000; color: #ffd700; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; border: 1px solid white; }
        
        .header-icons { display: flex; gap: 15px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 18px; color: #555; transition: transform 0.2s, color 0.3s; }
        .icon-btn:hover { transform: scale(1.1); color: #000; }
        .logout-btn { color: #ff4444; }
        .add-group-btn { background: #ffd700; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #000; }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #e5e5e5; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; position: relative; overflow: hidden; transition: background 0.3s; }
        .chat-header { padding: 0 15px; height: 60px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; cursor: pointer; transition: background 0.3s, border 0.3s; }
        .back-btn { display: none; margin-right: 15px; font-size: 20px; color: #555; cursor: pointer; }
        
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }
        
        .message { max-width: 85%; padding: 10px 15px; border-radius: 10px; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; position: relative; color: #000; }
        .message.sent { align-self: flex-end; background: #ffd700; color: #000; border-top-right-radius: 0; }
        .message.received { align-self: flex-start; background: white; color: #333; border-top-left-radius: 0; }
        .system-msg { align-self: center; background: #eee; font-size: 12px; color: #666; border-radius: 20px; padding: 5px 15px; text-align: center;}
        
        .msg-sender-name { font-size: 11px; font-weight: bold; color: #555; margin-bottom: 2px; display: block; }
        .msg-image { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .msg-time { display: block; font-size: 11px; margin-top: 4px; text-align: right; opacity: 0.7; }
        .delete-btn { display: none; position: absolute; top: -10px; right: -10px; background: #ff4444; color: white; border-radius: 50%; width: 20px; height: 20px; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .message.sent:hover .delete-btn { display: flex; }

        .chat-input-area { padding: 10px; background: #fff; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); transition: background 0.3s, border 0.3s; }
        .chat-input-area input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 2px solid #ddd; outline: none; font-size: 16px; background: #fff; color: #000; transition: background 0.3s, color 0.3s, border 0.3s; }
        .chat-input-area input[type="text"]:focus { border-color: #ffd700; }
        .circle-btn { background: #ffd700; color: #000; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .clip-btn { background: #f0f0f0; color: #555; margin-right: 5px; }

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; color: #000; transition: background 0.3s, color 0.3s; }
        .modal h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-list { margin: 10px 0; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .kick-btn { color: red; cursor: pointer; font-size: 14px; }
        .admin-crown { color: gold; margin-left: 5px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .btn-modal { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-cancel { background: #ddd; color: #000; }
        .btn-create { background: #ffd700; color: black; font-weight: bold; }

        /* === MODO OSCURO === */
        body.dark-mode { background-color: #121212; color: #e0e0e0; }
        body.dark-mode .app-container { background: #121212; }
        body.dark-mode .sidebar { background-color: #1e1e1e; border-right: 1px solid #333; }
        body.dark-mode .sidebar-header { background: #1e1e1e; border-bottom: 2px solid #ffd700; }
        body.dark-mode .my-name { color: #fff; }
        body.dark-mode .my-about { color: #aaa; }
        body.dark-mode .icon-btn { color: #aaa; }
        body.dark-mode .icon-btn:hover { color: #fff; }
        body.dark-mode .search-box { border-bottom: 1px solid #333; }
        body.dark-mode .search-input { background: #2c2c2c; border: 1px solid #444; color: #fff; }
        body.dark-mode .contact { border-bottom: 1px solid #333; }
        body.dark-mode .contact:hover { background-color: #2a2a2a; }
        body.dark-mode .contact.active-chat { background-color: #332b00; } 
        body.dark-mode .contact-name { color: #eee; }
        body.dark-mode .contact-last-msg, body.dark-mode .status-text { color: #888; }
        body.dark-mode .chat-area { background: #0d0d0d; background-image: radial-gradient(#333 1px, transparent 1px); }
        body.dark-mode .chat-header { background: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .back-btn { color: #eee; }
        body.dark-mode .message.received { background: #2c2c2c; color: #eee; }
        body.dark-mode .message.sent { background: #ffd700; color: #000; } 
        body.dark-mode .system-msg { background: #333; color: #aaa; }
        body.dark-mode .msg-sender-name { color: #bbb; }
        body.dark-mode .chat-input-area { background: #1e1e1e; border-top: 1px solid #333; }
        body.dark-mode .chat-input-area input[type="text"] { background: #2c2c2c; border: 1px solid #444; color: #fff; }
        body.dark-mode .clip-btn { background: #333; color: #ccc; }
        body.dark-mode .modal-content { background: #1e1e1e; color: #eee; }
        body.dark-mode .modal h3 { border-bottom: 1px solid #333; }
        body.dark-mode .member-item { border-bottom: 1px solid #333; }
        body.dark-mode .btn-cancel { background: #333; color: #eee; }
        body.dark-mode .status-dot { border-color: #1e1e1e; }

        /* --- DISEÑO MÓVIL --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; display: flex; }
            .chat-area { display: none; width: 100%; }
            body.chat-active .sidebar { display: none; }
            body.chat-active .chat-area { display: flex; }
            .back-btn { display: block; }
            .message.sent .delete-btn { display: flex; opacity: 0.8; }
            
            .my-profile-info, .sidebar-header span { display: none; }
            .sidebar-header { justify-content: space-between; }
            .logout-btn { margin-left: 0; }
        }
    </style>
</head>
<body>

    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3" preload="auto"></audio>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center;">
                    <div style="position: relative;">
                        <div class="user-avatar" id="mi-avatar-container"></div>
                        <div class="change-avatar-btn" onclick="cambiarMiAvatar()" title="Cambiar foto">
                            <i class="fas fa-sync"></i>
                        </div>
                    </div>
                    <div class="my-profile-info">
                        <div class="my-name" id="mi-nombre-display">Yo</div>
                        <div class="my-about" onclick="editarMiAbout()">
                            <span id="mi-about-display">Disponible</span> <i class="fas fa-pencil-alt"></i>
                        </div>
                    </div>
                </div>
                
                <div class="header-icons">
                    <i class="fas fa-moon icon-btn" onclick="toggleDarkMode()" title="Modo Oscuro" id="theme-icon"></i>
                    <i class="fas fa-sign-out-alt icon-btn logout-btn" onclick="cerrarSesion()" title="Cerrar Sesión"></i>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="input-busqueda" class="search-input" placeholder="Buscar..." onkeyup="filtrarContactos()">
                <button class="add-group-btn" onclick="abrirModalGrupo()"><i class="fas fa-plus"></i></button>
            </div>
            
            <div class="contact-list" id="lista-contactos"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <i class="fas fa-arrow-left back-btn" onclick="volverALista()"></i>
                <div class="user-avatar active-avatar" id="header-avatar" onclick="verInfoChatActual()">
                    <i class="fas fa-users"></i>
                </div>
                <div onclick="verInfoChatActual()" style="flex:1;">
                    <div class="contact-name" id="titulo-chat" style="font-weight:bold;">Chat General</div>
                    <small id="subtitulo-chat" style="color:#666;">Toca para info</small>
                </div>
            </div>

            <div class="chat-messages" id="chat-box"></div>

            <div class="chat-input-area">
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <button class="circle-btn clip-btn" onclick="document.getElementById('image-input').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="text" id="message-input" placeholder="Escribe..." autocomplete="off" maxlength="500">
                <button class="circle-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-grupo" class="modal">
        <div class="modal-content">
            <h3>Nuevo Grupo</h3>
            <input type="text" id="nombre-nuevo-grupo" class="search-input" placeholder="Nombre del grupo" style="margin-bottom: 10px;">
            <p>Miembros:</p>
            <div id="lista-usuarios-modal" class="modal-list"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="cerrarModal('modal-grupo')">Cancelar</button>
                <button class="btn-modal btn-create" onclick="crearGrupo()">Crear</button>
            </div>
        </div>
    </div>

    <div id="modal-info" class="modal">
        <div class="modal-content">
            <h3 id="info-titulo">Info del Grupo</h3>
            <p><strong>Creador:</strong> <span id="info-creador"></span></p>
            <p>Miembros:</p>
            <div id="info-lista-miembros" class="modal-list"></div>
            <div id="info-agregar-container" style="border-top:1px solid #eee; padding-top:10px;">
                <p>Agregar participante:</p>
                <select id="select-agregar-usuario" class="search-input" style="margin-bottom:5px;"></select>
                <button class="btn-modal btn-create" style="width:100%;" onclick="agregarMiembroGrupo()">Agregar</button>
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="cerrarModal('modal-info')">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        const username = localStorage.getItem("tecchat_usuario");
        if (!username) { window.location.href = "/"; }
        document.getElementById("mi-nombre-display").innerText = username;

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            const isDark = document.body.classList.contains("dark-mode");
            localStorage.setItem("tecchat_theme", isDark ? "dark" : "light");
            const icon = document.getElementById("theme-icon");
            icon.className = isDark ? "fas fa-sun icon-btn" : "fas fa-moon icon-btn";
        }
        const savedTheme = localStorage.getItem("tecchat_theme");
        if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            document.getElementById("theme-icon").className = "fas fa-sun icon-btn";
        }

        function cerrarSesion() {
            if(confirm("¿Cerrar sesión?")) {
                localStorage.removeItem("tecchat_usuario");
                window.location.href = "/";
            }
        }

        function formatearHoraLocal(fechaISO) {
            if (!fechaISO) return "";
            try {
                const fecha = new Date(fechaISO);
                if (isNaN(fecha.getTime())) return fechaISO;
                return fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) { return fechaISO; }
        }

        function irAChat() { document.body.classList.add("chat-active"); }
        function volverALista() {
            document.body.classList.remove("chat-active");
            chatActual = ""; 
            actualizarClaseActiva();
        }

        let chatActual = "";
        let esGrupoActual = false;
        let todosLosMensajes = []; 
        let contadoresNoLeidos = {}; 
        let todosLosUsuarios = [];
        let usuariosOnlineGlobal = [];

        async function editarMiAbout() {
            const nuevo = prompt("Escribe tu estado (ej: Ocupado):");
            if(nuevo && nuevo.trim() !== "") {
                document.getElementById("mi-about-display").innerText = nuevo;
                try {
                    await fetch("/update-about", {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({username: username, about: nuevo})
                    });
                } catch(e) {}
            }
        }

        async function verInfoChatActual() {
            if (!esGrupoActual) return;
            const modal = document.getElementById("modal-info");
            document.getElementById("info-titulo").innerText = chatActual;
            const res = await fetch(`/grupo/${chatActual}`);
            if(!res.ok) return;
            const info = await res.json();
            document.getElementById("info-creador").innerText = info.creador;
            const lista = document.getElementById("info-lista-miembros");
            lista.innerHTML = "";
            const soyCreador = (info.creador === username);
            info.miembros.forEach(m => {
                let html = `<div class="member-item"><span>${m} ${m === info.creador ? '<i class="fas fa-crown admin-crown"></i>' : ''}</span>`;
                if (soyCreador && m !== username) { html += `<i class="fas fa-trash kick-btn" onclick="expulsarDeGrupo('${m}')"></i>`; }
                html += `</div>`;
                lista.innerHTML += html;
            });
            const select = document.getElementById("select-agregar-usuario");
            select.innerHTML = "";
            todosLosUsuarios.forEach(u => {
                if (!info.miembros.includes(u.username)) { select.innerHTML += `<option value="${u.username}">${u.username}</option>`; }
            });
            modal.style.display = "flex";
        }

        async function expulsarDeGrupo(target) {
            if(!confirm(`¿Expulsar a ${target}?`)) return;
            await fetch("/grupo/expulsar", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({nombre_grupo: chatActual, solicitante: username, target_user: target}) });
            verInfoChatActual();
        }

        async function agregarMiembroGrupo() {
            const target = document.getElementById("select-agregar-usuario").value;
            if(!target) return;
            await fetch("/grupo/agregar", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({nombre_grupo: chatActual, solicitante: username, target_user: target}) });
            verInfoChatActual();
        }

        function generarUrlAvatar(semilla) { return `https://api.dicebear.com/7.x/avataaars/svg?seed=${semilla}`; }

        async function cambiarMiAvatar() {
            const randomSeed = username + Math.floor(Math.random() * 10000);
            const nuevaUrl = generarUrlAvatar(randomSeed);
            document.getElementById("mi-avatar-container").innerHTML = `<img src="${nuevaUrl}" alt="Yo">`;
            await fetch("/update-avatar", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({username: username, avatar_url: nuevaUrl}) });
        }

        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(`${protocol}://${window.location.host}/ws/${username}`);

        socket.onclose = function(event) {
            console.log("Conexión perdida. Reintentando...");
            const title = document.getElementById("titulo-chat");
            if(title) { title.innerText = "Reconectando..."; title.style.color = "red"; }
            setTimeout(() => location.reload(), 3000);
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === "STATUS") {
                usuariosOnlineGlobal = data.online_users;
                actualizarEstadoUsuarios(usuariosOnlineGlobal);
            }
            else if (data.type === "REFRESH_USERS") {
                recargarSidebar();
            }
            else if (data.type === "DELETE") {
                eliminarMensajeDePantalla(data.id);
            }
            else if (data.type === "CHAT") {
                todosLosMensajes.push(data);
                renderizarMensaje(data);
                manejarNotificacion(data);
                if (data.sender !== username && data.sender !== "Sistema") {
                    try {
                        const audio = document.getElementById("notification-sound");
                        audio.currentTime = 0; 
                        audio.play().catch(e => console.log("Sonido bloqueado"));
                    } catch (e) {}
                }
            }
        };

        function manejarNotificacion(data) {
            if (data.sender === username) { moverContactoArriba(data.recipient); return; }
            if (data.sender === "Sistema") return;
            let remitente = "";
            if (data.recipient === "Chat General") remitente = "Chat General";
            else if (data.is_group) remitente = data.recipient;
            else remitente = data.sender;
            
            moverContactoArriba(remitente);
            if (remitente !== chatActual) {
                if (!contadoresNoLeidos[remitente]) contadoresNoLeidos[remitente] = 0;
                contadoresNoLeidos[remitente]++;
                actualizarBadge(remitente, contadoresNoLeidos[remitente]);
            }
        }

        function moverContactoArriba(nombre) {
            const lista = document.getElementById("lista-contactos");
            let el = (nombre === "Chat General") ? document.getElementById("contact-general") : document.querySelector(`.contact[data-name="${nombre}"]`);
            if(el) lista.prepend(el);
        }
        function actualizarBadge(nombre, n) {
            let el = (nombre === "Chat General") ? document.getElementById("contact-general") : document.querySelector(`.contact[data-name="${nombre}"]`);
            if(el) { let b = el.querySelector(".unread-badge"); if(b) {b.innerText=n; b.style.display="inline-block";} }
        }
        function limpiarBadge(nombre) {
            contadoresNoLeidos[nombre]=0;
            let el = (nombre === "Chat General") ? document.getElementById("contact-general") : document.querySelector(`.contact[data-name="${nombre}"]`);
            if(el) { let b = el.querySelector(".unread-badge"); if(b) b.style.display="none"; }
        }
        function eliminarMensajeDePantalla(id) {
            todosLosMensajes=todosLosMensajes.filter(m=>m.id!==id);
            let el=document.getElementById("msg-"+id); if(el) el.remove();
        }
        function solicitarBorrado(id) { if(confirm("¿Borrar?")) socket.send(JSON.stringify({action:"delete", id:id})); }

        function actualizarEstadoUsuarios(listaOnline) {
            const divs = document.querySelectorAll(".contact-user");
            divs.forEach(div => {
                if(div.classList.contains('is-group')) return;
                const nombre = div.getAttribute("data-name");
                const puntito = div.querySelector(".status-dot");
                
                if (listaOnline.includes(nombre)) {
                    if(puntito) puntito.classList.add("is-online");
                } else {
                    if(puntito) puntito.classList.remove("is-online");
                }
            });

            // Actualizar estado en cabecera si estoy en chat privado
            if (chatActual && !esGrupoActual && chatActual !== "Chat General") {
                const sub = document.getElementById("subtitulo-chat");
                if (listaOnline.includes(chatActual)) {
                    sub.innerText = "En línea";
                    sub.style.color = "#25d366";
                    sub.style.fontWeight = "bold";
                } else {
                    sub.innerText = "Desconectado";
                    sub.style.color = "#666";
                    sub.style.fontWeight = "normal";
                }
            }
        }

        function cambiarChat(nuevo, avatar, esGrupo=false) {
            chatActual=nuevo; esGrupoActual=esGrupo; limpiarBadge(chatActual);
            
            if (window.innerWidth <= 768) irAChat();

            document.getElementById("titulo-chat").innerText=chatActual;
            
            let textoEstado = "Desconectado";
            if (esGrupo) textoEstado = "Toca para ver miembros";
            else if (nuevo === "Chat General") textoEstado = "Sala pública";
            else if (usuariosOnlineGlobal.includes(nuevo)) textoEstado = "En línea";

            const sub = document.getElementById("subtitulo-chat");
            sub.innerText = textoEstado;
            sub.style.color = (textoEstado === "En línea") ? "#25d366" : "#666";
            sub.style.fontWeight = (textoEstado === "En línea") ? "bold" : "normal";

            const head=document.getElementById("header-avatar");
            if(chatActual==="Chat General") { head.innerHTML=`<i class="fas fa-users"></i>`; }
            else if(esGrupo) { head.innerHTML=`<i class="fas fa-user-friends"></i>`; head.style.backgroundColor="#e1bee7"; }
            else { head.innerHTML=`<img src="${avatar}" alt="${chatActual}">`; head.style.backgroundColor="#eee"; }
            
            document.getElementById("chat-box").innerHTML="";
            todosLosMensajes.forEach(msg=>renderizarMensaje(msg));
            actualizarClaseActiva();
        }

        function renderizarMensaje(data) {
            const chatBox = document.getElementById("chat-box");
            let mostrar = false;
            if (chatActual === "Chat General") { if (data.recipient === "Chat General") mostrar = true; } 
            else if (esGrupoActual) { if (data.recipient === chatActual) mostrar = true; } 
            else { 
                const esDeEl = (data.sender === chatActual && data.recipient === username);
                const esMio  = (data.sender === username && data.recipient === chatActual);
                if (esDeEl || esMio) mostrar = true; 
            }

            if (mostrar) {
                const msgDiv = document.createElement("div");
                if(data.id) msgDiv.id="msg-"+data.id;
                if (data.sender === "Sistema") {
                    msgDiv.className = "system-msg"; msgDiv.innerText = data.message;
                } else {
                    msgDiv.className = (data.sender === username) ? "message sent" : "message received";
                    let content = data.message.startsWith("data:image") ? `<img src="${data.message}" class="msg-image">` : data.message;
                    let inner = "";
                    if(data.sender === username) inner += `<div class="delete-btn" onclick="solicitarBorrado(${data.id})"><i class="fas fa-trash"></i></div>`;
                    if ((chatActual === "Chat General" || esGrupoActual) && data.sender !== username) inner += `<span class="msg-sender-name">${data.sender}</span>`;
                    
                    const horaBonita = formatearHoraLocal(data.timestamp);
                    inner += content + `<span class="msg-time">${horaBonita} <i class="fas fa-check" style="margin-left:3px;"></i></span>`;
                    msgDiv.innerHTML = inner;
                }
                chatBox.appendChild(msgDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            const val = input.value.trim();
            if(val) { enviarPayload(val); input.value=""; }
        }
        function enviarPayload(txt) { socket.send(JSON.stringify({recipient:chatActual, message:txt, is_group:esGrupoActual})); }
        document.getElementById("message-input").addEventListener("keypress", function(e){if(e.key==="Enter")sendMessage()});
        
        document.getElementById('image-input').addEventListener('change', function(e) {
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader();
            r.onload=function(ev){
                const i=new Image(); i.onload=function(){
                    const c=document.createElement('canvas'); const ctx=c.getContext('2d');
                    const MAX=800; let w=i.width; let h=i.height;
                    if(w>MAX){h*=MAX/w; w=MAX;} c.width=w; c.height=h;
                    ctx.drawImage(i,0,0,w,h); enviarPayload(c.toDataURL('image/jpeg',0.7));
                }; i.src=ev.target.result;
            }; r.readAsDataURL(f); e.target.value='';
        });

        // --- FILTRO Y MODALES ---
        function filtrarContactos() {
            const fil=document.getElementById('input-busqueda').value.toUpperCase();
            const list=document.getElementById("lista-contactos").children;
            for(let i=0; i<list.length; i++) {
                const name=list[i].getAttribute("data-name");
                if(name && name.toUpperCase().indexOf(fil)>-1) list[i].style.display=""; else list[i].style.display="none";
            }
        }
        function abrirModalGrupo() {
            const l=document.getElementById("lista-usuarios-modal"); l.innerHTML="";
            todosLosUsuarios.forEach(u=>{ if(u.username!==username) l.innerHTML+=`<div style="padding:5px;"><input type="checkbox" value="${u.username}"> ${u.username}</div>`; });
            document.getElementById("modal-grupo").style.display="flex";
        }
        function cerrarModal(id){ document.getElementById(id).style.display="none"; }
        async function crearGrupo() {
            const n=document.getElementById("nombre-nuevo-grupo").value.trim();
            const m=Array.from(document.querySelectorAll("#lista-usuarios-modal input:checked")).map(c=>c.value);
            if(!n || m.length===0) return alert("Faltan datos");
            await fetch("/crear-grupo", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({nombre:n, creador:username, miembros:m})});
            cerrarModal('modal-grupo');
            recargarSidebar(); // Forzar recarga inmediata para el creador
        }

        // --- RECARGAR SIDEBAR Y RESTAURAR ESTADOS ---
        async function recargarSidebar() {
            const resU=await fetch("/lista-usuarios/"); todosLosUsuarios=await resU.json();
            const resG=await fetch(`/mis-grupos/${username}`); const misGrupos=await resG.json();
            
            const cont=document.getElementById("lista-contactos");
            cont.innerHTML=`<div class="contact active-chat" id="contact-general" data-name="Chat General" onclick="cambiarChat('Chat General','',false)"><div class="user-avatar active-avatar"><i class="fas fa-users" style="color:#555;"></i></div><div class="contact-info"><div class="contact-row-top"><div class="name-wrapper">Chat General</div><span class="unread-badge"></span></div><div class="contact-row-bottom"><span class="status-text">Sala pública</span></div></div></div>`;
            
            const yo = todosLosUsuarios.find(u=>u.username===username);
            if(yo) {
                if(yo.avatar) document.getElementById("mi-avatar-container").innerHTML=`<img src="${yo.avatar}" alt="Yo">`;
                if(yo.about) document.getElementById("mi-about-display").innerText=yo.about;
            } else {
                document.getElementById("mi-avatar-container").innerHTML=`<img src="${generarUrlAvatar(username)}" alt="Yo">`;
            }

            misGrupos.forEach(g=>{
                cont.innerHTML+=`<div class="contact is-group" data-name="${g.nombre}" onclick="cambiarChat('${g.nombre}','',true)"><div class="user-avatar" style="background-color:#e1bee7;"><i class="fas fa-user-friends" style="color:#6a1b9a;"></i></div><div class="contact-info"><div class="contact-row-top"><div class="name-wrapper">${g.nombre}</div><span class="unread-badge"></span></div><div class="contact-row-bottom"><span class="status-text">Grupo</span></div></div></div>`;
            });

            todosLosUsuarios.forEach(u=>{
                if(u.username!==username) {
                    const av=u.avatar?u.avatar:generarUrlAvatar(u.username);
                    const st=u.about?u.about:"Desconectado";
                    cont.innerHTML+=`<div class="contact contact-user" data-name="${u.username}" data-about="${st}" onclick="cambiarChat('${u.username}','${av}',false)"><div class="user-avatar"><img src="${av}" alt="${u.username}"><span class="status-dot"></span></div><div class="contact-info"><div class="contact-row-top"><div class="name-wrapper">${u.username}</div><span class="unread-badge"></span></div><div class="contact-row-bottom"><span class="status-text">${st}</span></div></div></div>`;
                }
            });

            // IMPORTANTÍSIMO: VOLVER A PINTAR LOS VERDES
            if(usuariosOnlineGlobal.length > 0) actualizarEstadoUsuarios(usuariosOnlineGlobal);
            actualizarClaseActiva();
        }

        async function inicializar() {
            await recargarSidebar();
            const resH=await fetch("/historial"); const hist=await resH.json();
            todosLosMensajes=hist; 
            
            if(window.innerWidth > 768 && !chatActual) {
                chatActual = "Chat General";
                actualizarClaseActiva();
                hist.forEach(msg=>renderizarMensaje(msg));
            } else if (chatActual) {
                cambiarChat(chatActual, "", chatActual !== "Chat General");
            }
        }

        function actualizarClaseActiva() {
            document.querySelectorAll('.contact').forEach(el => el.classList.remove('active-chat'));
            if (chatActual === "Chat General") {
                const gen = document.getElementById('contact-general');
                if(gen) gen.classList.add('active-chat');
            } else {
                const item = document.querySelector(`.contact[data-name="${chatActual}"]`);
                if (item) item.classList.add('active-chat');
            }
        }

        inicializar();
    </script>
</body>
</html>