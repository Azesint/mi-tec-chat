<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecChat - Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS VISUALES (TEMA AMARILLO) --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; background-color: #fff; }
        .app-container { display: flex; width: 100%; height: 100vh; max-width: none; margin: 0; background: #fff; }
        
        .sidebar { width: 300px; min-width: 250px; border-right: 1px solid #eee; display: flex; flex-direction: column; background-color: #f9f9f9; }
        .sidebar-header { padding: 15px; background: #fff; border-bottom: 3px solid #ffd700; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .search-box { padding: 10px; border-bottom: 1px solid #eee; }
        .search-input { width: 90%; padding: 8px; border-radius: 20px; border: 2px solid #eee; outline: none; }
        .search-input:focus { border-color: #ffd700; } 
        .contact-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        .contact { display: flex; align-items: center; padding: 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; order: 1; }
        .contact:hover { background-color: #fff9c4; } 
        .contact.active-chat { background-color: #ffe082; } 
        
        .user-avatar { 
            width: 45px; height: 45px; background: #eee; border-radius: 50%; margin-right: 15px; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; position: relative;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-avatar i { font-size: 20px; color: #555; }
        .active-avatar { border-color: #ffd700; }

        .change-avatar-btn {
            position: absolute; bottom: -2px; right: -2px; background: #000; color: #ffd700;
            border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex;
            align-items: center; justify-content: center; cursor: pointer; z-index: 10; border: 1px solid white;
        }
        .change-avatar-btn:hover { transform: scale(1.1); }
        
        .status-dot { height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 2px rgba(0,0,0,0.2); transition: background-color 0.3s; }
        .is-online { background-color: #25d366; box-shadow: 0 0 5px #25d366; }

        .unread-badge {
            background-color: #ff3b30; color: white; font-size: 11px; font-weight: bold;
            padding: 2px 6px; border-radius: 10px; margin-left: auto; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .chat-area { flex: 1; display: flex; flex-direction: column; background: #e5e5e5; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }
        .chat-header { padding: 0 20px; height: 60px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 70%; padding: 10px 15px; border-radius: 10px; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; position: relative;}
        .message.sent { align-self: flex-end; background: #ffd700; color: #000; border-top-right-radius: 0; }
        .message.received { align-self: flex-start; background: white; color: #333; border-top-left-radius: 0; }
        .system-msg { align-self: center; background: #eee; font-size: 12px; color: #666; border-radius: 20px; padding: 5px 15px; }

        .msg-image { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; transition: transform 0.2s;}
        .msg-image:hover { transform: scale(1.02); }
        .msg-time { display: block; font-size: 11px; margin-top: 4px; text-align: right; opacity: 0.7; }

        .delete-btn {
            display: none; position: absolute; top: -10px; right: -10px;
            background: #ff4444; color: white; border-radius: 50%; width: 20px; height: 20px;
            align-items: center; justify-content: center; font-size: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .message.sent:hover .delete-btn { display: flex; }

        .chat-input-area { padding: 15px; background: #fff; display: flex; gap: 10px; align-items: center; }
        .chat-input-area input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 2px solid #ddd; outline: none; }
        .chat-input-area input[type="text"]:focus { border-color: #ffd700; }
        
        .circle-btn { background: #ffd700; color: #000; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .circle-btn:hover { background: #e6c200; }
        .clip-btn { background: #f0f0f0; color: #555; margin-right: 5px;} 
        .clip-btn:hover { background: #ddd; }

        @media (max-width: 768px) {
            .sidebar { width: 70px; min-width: 70px; }
            .contact-info, .search-box, .sidebar-header span { display: none; }
            .user-avatar { margin-right: 0; }
            .contact { justify-content: center; padding: 15px 0; }
            .sidebar-header { justify-content: center; }
            .unread-badge { position: absolute; top: 5px; right: 5px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="position: relative;">
                    <div class="user-avatar" id="mi-avatar-container"></div>
                    <div class="change-avatar-btn" onclick="cambiarMiAvatar()" title="Cambiar foto al azar">
                        <i class="fas fa-sync"></i>
                    </div>
                </div>
                <span id="mi-nombre-display">Mi Perfil</span>
            </div>
            
            <div class="search-box">
                <input type="text" id="input-busqueda" class="search-input" placeholder="Buscar..." onkeyup="filtrarContactos()">
            </div>
            
            <div class="contact-list" id="lista-contactos"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="user-avatar active-avatar" id="header-avatar">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <div class="contact-name" id="titulo-chat" style="font-weight:bold;">Chat General</div>
                </div>
            </div>

            <div class="chat-messages" id="chat-box"></div>

            <div class="chat-input-area">
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <button class="circle-btn clip-btn" onclick="document.getElementById('image-input').click()" title="Enviar imagen">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="text" id="message-input" placeholder="Escribe..." autocomplete="off">
                <button class="circle-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- SEGURIDAD: LEER USUARIO DEL LOCALSTORAGE ---
        const username = localStorage.getItem("tecchat_usuario");
        if (!username) { window.location.href = "/"; }
        document.getElementById("mi-nombre-display").innerText = username;

        let chatActual = "Chat General"; 
        let todosLosMensajes = []; 
        let contadoresNoLeidos = {}; 

        // --- FILTRO DE BÚSQUEDA ---
        function filtrarContactos() {
            const input = document.getElementById('input-busqueda');
            const filtro = input.value.toUpperCase();
            const lista = document.getElementById("lista-contactos");
            const contactos = lista.getElementsByClassName('contact-user');
            for (let i = 0; i < contactos.length; i++) {
                const nombre = contactos[i].getAttribute("data-name");
                if (nombre.toUpperCase().indexOf(filtro) > -1) {
                    contactos[i].style.display = ""; 
                } else {
                    contactos[i].style.display = "none";
                }
            }
        }

        // --- AVATARES ---
        function generarUrlAvatar(semilla) {
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${semilla}`;
        }

        async function cambiarMiAvatar() {
            const randomSeed = username + Math.floor(Math.random() * 10000);
            const nuevaUrl = generarUrlAvatar(randomSeed);
            document.getElementById("mi-avatar-container").innerHTML = `<img src="${nuevaUrl}" alt="Yo">`;
            try {
                await fetch("/update-avatar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: username, avatar_url: nuevaUrl })
                });
            } catch(e) { console.error("Error guardando avatar", e); }
        }

        // --- WEBSOCKET ---
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(`${protocol}://${window.location.host}/ws/${username}`);

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === "STATUS") {
                actualizarEstadoUsuarios(data.online_users);
            } 
            else if (data.type === "DELETE") {
                eliminarMensajeDePantalla(data.id);
            }
            else if (data.type === "CHAT") {
                todosLosMensajes.push(data);
                renderizarMensaje(data);
                manejarNotificacion(data);
            }
        };

        // --- LÓGICA DE NOTIFICACIONES Y REORDENAMIENTO ---
        function manejarNotificacion(data) {
            if (data.sender === username) {
                moverContactoArriba(data.recipient);
                return;
            }
            if (data.sender === "Sistema") return;

            let remitente = (data.recipient === "Chat General") ? "Chat General" : data.sender;
            moverContactoArriba(remitente);

            if (remitente !== chatActual) {
                if (!contadoresNoLeidos[remitente]) contadoresNoLeidos[remitente] = 0;
                contadoresNoLeidos[remitente]++;
                actualizarBadge(remitente, contadoresNoLeidos[remitente]);
            }
        }

        function moverContactoArriba(nombreContacto) {
            const lista = document.getElementById("lista-contactos");
            let divContacto;
            if (nombreContacto === "Chat General") {
                divContacto = document.getElementById("contact-general");
            } else {
                divContacto = document.querySelector(`.contact-user[data-name="${nombreContacto}"]`);
            }
            if (divContacto) lista.prepend(divContacto);
        }

        function actualizarBadge(nombreContacto, cantidad) {
            let divContacto;
            if (nombreContacto === "Chat General") {
                divContacto = document.getElementById("contact-general");
            } else {
                divContacto = document.querySelector(`.contact-user[data-name="${nombreContacto}"]`);
            }
            if (divContacto) {
                const badge = divContacto.querySelector(".unread-badge");
                if (badge) {
                    badge.innerText = cantidad;
                    badge.style.display = "inline-block"; 
                }
            }
        }

        function limpiarBadge(nombreContacto) {
            contadoresNoLeidos[nombreContacto] = 0;
            let divContacto;
            if (nombreContacto === "Chat General") {
                divContacto = document.getElementById("contact-general");
            } else {
                divContacto = document.querySelector(`.contact-user[data-name="${nombreContacto}"]`);
            }
            if (divContacto) {
                const badge = divContacto.querySelector(".unread-badge");
                if (badge) badge.style.display = "none";
            }
        }

        function eliminarMensajeDePantalla(id) {
            todosLosMensajes = todosLosMensajes.filter(m => m.id !== id);
            const elemento = document.getElementById("msg-" + id);
            if (elemento) elemento.remove();
        }

        function solicitarBorrado(id) {
            if(confirm("¿Seguro que quieres borrar este mensaje?")) {
                const payload = { action: "delete", id: id };
                socket.send(JSON.stringify(payload));
            }
        }

        function actualizarEstadoUsuarios(listaOnline) {
            const contactosDivs = document.querySelectorAll(".contact-user");
            contactosDivs.forEach(div => {
                const nombreUsuario = div.getAttribute("data-name");
                const puntito = div.querySelector(".status-dot");
                if (listaOnline.includes(nombreUsuario)) {
                    puntito.classList.add("is-online");
                    div.querySelector(".estado-texto").innerText = "En línea";
                    div.querySelector(".estado-texto").style.color = "#25d366";
                } else {
                    puntito.classList.remove("is-online");
                    div.querySelector(".estado-texto").innerText = "Desconectado";
                    div.querySelector(".estado-texto").style.color = "#aaa";
                }
            });
        }

        function cambiarChat(nuevoDestinatario, avatarUrl) {
            chatActual = nuevoDestinatario;
            limpiarBadge(chatActual);

            document.getElementById("titulo-chat").innerText = chatActual;
            const headerAvatar = document.getElementById("header-avatar");
            
            if (chatActual === "Chat General") {
                headerAvatar.innerHTML = `<i class="fas fa-users"></i>`;
            } else {
                headerAvatar.innerHTML = `<img src="${avatarUrl}" alt="${chatActual}">`;
            }
            document.getElementById("chat-box").innerHTML = "";
            todosLosMensajes.forEach(msg => renderizarMensaje(msg));
            actualizarClaseActiva();
        }

        function renderizarMensaje(data) {
            const chatBox = document.getElementById("chat-box");
            let mostrar = false;
            if (chatActual === "Chat General") {
                if (data.recipient === "Chat General" || data.recipient === "Todos") mostrar = true;
            } else {
                const esDeEl = (data.sender === chatActual && data.recipient === username);
                const esMio  = (data.sender === username && data.recipient === chatActual);
                if (esDeEl || esMio) mostrar = true;
            }

            if (mostrar) {
                const msgDiv = document.createElement("div");
                if (data.id) msgDiv.id = "msg-" + data.id;

                if (data.sender === "Sistema") {
                    msgDiv.className = "system-msg";
                    msgDiv.innerText = data.message;
                } else {
                    msgDiv.className = (data.sender === username) ? "message sent" : "message received";
                    
                    let contentHtml = "";
                    if (data.message.startsWith("data:image")) {
                        contentHtml = `<img src="${data.message}" class="msg-image">`;
                    } else {
                        contentHtml = data.message;
                    }
                    let inner = "";
                    
                    if (data.sender === username) {
                        inner += `<div class="delete-btn" onclick="solicitarBorrado(${data.id})"><i class="fas fa-trash"></i></div>`;
                    }

                    if (chatActual === "Chat General" && data.sender !== username) {
                        inner += `<strong>${data.sender}:</strong> <br>`;
                    }
                    inner += contentHtml;
                    const hora = data.timestamp || ""; 
                    inner += `<span class="msg-time">${hora}</span>`;
                    msgDiv.innerHTML = inner;
                }
                chatBox.appendChild(msgDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            const texto = input.value.trim();
            if(texto !== "") {
                enviarPayload(texto);
                input.value = "";
            }
        }

        function enviarPayload(contenido) {
            const payload = { recipient: chatActual, message: contenido };
            socket.send(JSON.stringify(payload));
        }

        document.getElementById("message-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMessage();
        });

        // --- AQUÍ ESTÁ LA NUEVA MAGIA: COMPRESIÓN DE IMÁGENES ---
        document.getElementById('image-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                // Creamos una imagen virtual
                const img = new Image();
                img.onload = function() {
                    // Creamos un canvas (lienzo) para redimensionar
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Definimos el tamaño máximo (800px es buen balance calidad/peso)
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    // Si es muy grande, la achicamos proporcionalmente
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convertimos a JPEG comprimido (Calidad 0.7)
                    // Esto reduce el peso drásticamente (de 3MB a ~100KB)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    enviarPayload(dataUrl);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; 
        });

        async function inicializar() {
            const resU = await fetch("/lista-usuarios/");
            const users = await resU.json();
            const container = document.getElementById("lista-contactos");
            
            container.innerHTML = `
                <div class="contact active-chat" id="contact-general" onclick="cambiarChat('Chat General', '')"> 
                    <div class="user-avatar active-avatar"><i class="fas fa-users" style="color:#555;"></i></div>
                    <div class="contact-info">
                        <div class="contact-name" style="font-weight:bold;">
                            Chat General
                            <span class="unread-badge"></span>
                        </div>
                        <div class="contact-last-msg" style="color:#666; font-size:12px;">Sala pública</div>
                    </div>
                </div>
            `;

            const yo = users.find(u => u.username === username);
            if (yo && yo.avatar) {
                document.getElementById("mi-avatar-container").innerHTML = `<img src="${yo.avatar}" alt="Yo">`;
            } else {
                const defaultAvatar = generarUrlAvatar(username);
                document.getElementById("mi-avatar-container").innerHTML = `<img src="${defaultAvatar}" alt="Yo">`;
            }

            users.forEach(u => {
                if (u.username !== username) {
                    const avatarUrl = u.avatar ? u.avatar : generarUrlAvatar(u.username);
                    container.innerHTML += `
                    <div class="contact contact-user" data-name="${u.username}" onclick="cambiarChat('${u.username}', '${avatarUrl}')">
                        <div class="user-avatar"><img src="${avatarUrl}" alt="${u.username}"></div>
                        <div class="contact-info">
                            <div class="contact-name" style="font-weight:600;">
                                ${u.username} 
                                <span class="status-dot"></span>
                                <span class="unread-badge"></span>
                            </div>
                            <div class="contact-last-msg estado-texto" style="color:#aaa; font-size:11px;">Desconectado</div>
                        </div>
                    </div>`;
                }
            });

            const resH = await fetch("/historial");
            const historial = await resH.json();
            todosLosMensajes = historial;
            historial.forEach(msg => renderizarMensaje(msg));
        }

        function actualizarClaseActiva() {
            document.querySelectorAll('.contact').forEach(el => el.classList.remove('active-chat'));
            if (chatActual === "Chat General") {
                document.getElementById('contact-general').classList.add('active-chat');
            } else {
                const userDiv = document.querySelector(`.contact-user[data-name="${chatActual}"]`);
                if (userDiv) userDiv.classList.add('active-chat');
            }
        }

        inicializar();
    </script>
</body>
</html>